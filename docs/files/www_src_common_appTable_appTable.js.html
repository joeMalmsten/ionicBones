<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>www/src/common/appTable/appTable.js - app</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="app" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 3.5.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/appFlyout.html">appFlyout</a></li>
                                <li><a href="../classes/appHeader.html">appHeader</a></li>
                                <li><a href="../classes/appInput.html">appInput</a></li>
                                <li><a href="../classes/appTable.html">appTable</a></li>
                                <li><a href="../classes/DashboardCtrl.html">DashboardCtrl</a></li>
                                <li><a href="../classes/FlyoutCtrl.html">FlyoutCtrl</a></li>
                                <li><a href="../classes/flyoutFactory.html">flyoutFactory</a></li>
                                <li><a href="../classes/hotkeysFactory.html">hotkeysFactory</a></li>
                                <li><a href="../classes/InputCtrl.html">InputCtrl</a></li>
                                <li><a href="../classes/LoginCtrl.html">LoginCtrl</a></li>
                                <li><a href="../classes/NavbarCtrl.html">NavbarCtrl</a></li>
                                <li><a href="../classes/TableCtrl.html">TableCtrl</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/app.bindHtmlCompile.html">app.bindHtmlCompile</a></li>
                                <li><a href="../modules/app.dashboard.html">app.dashboard</a></li>
                                <li><a href="../modules/app.filters.html">app.filters</a></li>
                                <li><a href="../modules/app.flyout.html">app.flyout</a></li>
                                <li><a href="../modules/app.hotkeys.html">app.hotkeys</a></li>
                                <li><a href="../modules/app.input.html">app.input</a></li>
                                <li><a href="../modules/app.login.html">app.login</a></li>
                                <li><a href="../modules/app.table.html">app.table</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: www/src/common/appTable/appTable.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/*global angular require*/
&#x27;use strict&#x27;;
var safeApply = require(&#x27;../safeApply/safeApply&#x27;);

require(&#x27;../appBindHtmlCompile/appBindHtmlCompile&#x27;);
require(&#x27;../appFlyout/appFlyout&#x27;);
require(&#x27;../../../lib/smoothscroll.min&#x27;);
require(&#x27;../appFilters/appFilters&#x27;);
require(&#x27;../hotkeys/hotkeys&#x27;);
require(&#x27;./appTable.html&#x27;);

/**
 * module contains the logic for generating tables.
 *
 * Dependencies: templates(third party), app.bindHtmlCompile, app.input, app.flyout,
 * app.filters, app.hotkeys
 *
 * @module app.table
 * @main
 */
angular.module(&#x27;app.table&#x27;, [&#x27;templates&#x27;, &#x27;app.bindHtmlCompile&#x27;, &#x27;app.input&#x27;, &#x27;app.flyout&#x27;, &#x27;app.filters&#x27;, &#x27;app.hotkeys&#x27;])
/**
 * A controller that contains the main logic for the table directive.
 *
 * @class TableCtrl
 */
.controller(&#x27;TableCtrl&#x27;, [function() {
}])
/**
 * A directive that contains the main logic for creating tables.
 *
 * @class appTable
 * @param {Object} $timeout
 *  Angular wrapper around SetTimeout
 * @param {Object} filterFilter
 *  angular filter for filtering ng-repeat. Slow and we should remove ng-repeat
 * @param {Object} hotkeysFactory
 *  Instantiation of the hotkey factory that manages all of our apps keybindings
 */
.directive(&#x27;appTable&#x27;, [&#x27;$timeout&#x27;, &#x27;filterFilter&#x27;, &#x27;hotkeysFactory&#x27;, function($timeout, filterFilter, hotkeysFactory) {
    return {
        restrict: &#x27;E&#x27;,
        replace: true,
        templateUrl: &#x27;appTable.html&#x27;,
        controller: &#x27;TableCtrl&#x27;,
        scope: {
            tableConfig: &#x27;=&#x27;,
            selectablePageSize: &#x27;=?&#x27;,
            pagingType: &#x27;@&#x27;
        },
        /**
         * Initializes the table, put logic here instead of in the controller
         *
         * @method link
         * @param {Object} scope
         *  The isolate scope of the directive
         * @param {Object} element
         *  The compiled element of the directive
         * @return none
         */
        link: function(scope, element) {
            var _ = require(&#x27;lodash&#x27;),
                filterInputElem,
                filterColumnElem,
                elem = $(element),
                tbody,
                thead,
                theadCols,
                trows,
                tcols = {},
                rowHeight,
                visibleStartRowMargin = 0.85,
                visibleEndRowMargin = 0.3,
                scrollbarWidth;

            /**
             * Sanitizes sorting predicates to be used with angular.
             *
             * @method sanitizePredicate
             * @param {String} predicate
             *  The name of the predicate we want to use for sorting.
             * @param {Boolean} reverse
             *  Whether or not we are sorting in Asc or Desc order.
             * @return {String} Sanitized predicate.
             */
            function sanitizePredicate(predicate, reverse) {
                var ret = &quot;&#x27;&quot;;

                if (reverse) {
                    ret = &#x27;-&#x27; + ret;
                }

                ret += predicate.replace([&quot;&#x27;&quot;, &#x27;-&#x27;], &#x27;&#x27;) + &quot;&#x27;&quot;;

                return ret;
            }

            /**
             * Inits keybindings for table when table is made, creates event
             * to destroy keybindings when table no longer exists
             *
             * @method initHotkeys
             * @return none
             */
            function initHotkeys() {
                var offFunction;
                hotkeysFactory.bind(&#x27;shift&#x27;, scope);

                offFunction = scope.$on(&#x27;$destroy&#x27;, function() {
                    hotkeysFactory.unbind(&#x27;shift&#x27;);
                    offFunction();
                });
            }

            /**
             * The width of the scrollbar needs to be taken into account when
             * resizing the scrollable table. Scrollbar width changes on OS and
             * browser so we need to create a scrollbar, get its&#x27; width and then
             * destroy it
             *
             * @method getScrollbarWidth
             * @return the width of a scroll bar on the users OS/Browser
             */
            function getScrollbarWidth() {
                var outer = document.createElement(&#x27;div&#x27;);
                outer.style.visibility = &#x27;hidden&#x27;;
                outer.style.width = &#x27;100px&#x27;;
                outer.style.msOverflowStyle = &#x27;scrollbar&#x27;; // needed for WinJS apps

                document.body.appendChild(outer);

                var widthNoScroll = outer.offsetWidth;
                // force scrollbars
                outer.style.overflow = &#x27;scroll&#x27;;

                // add innerdiv
                var inner = document.createElement(&#x27;div&#x27;);
                inner.style.width = &#x27;100%&#x27;;
                outer.appendChild(inner);

                var widthWithScroll = inner.offsetWidth;

                // remove divs
                outer.parentNode.removeChild(outer);

                return widthNoScroll - widthWithScroll;
            }

            /**
             * Resizes the column widths to make the scrollable table fit every-
             * thing without having to create a line-break in a row
             *
             * @method setColumnWidths
             * @return none
             */
            function setColumnWidths() {
                var currColHeader,
                    columnCells,
                    cellData,
                    headerWidth,
                    cellWidth,
                    cellDataWidth = 0;


                _.each(scope.tableColumns, function(value, index) {
                    var newWidth;

                    columnCells = tcols[value];
                    currColHeader = theadCols.filter(&quot;[data-col-header=&#x27;&quot; + value + &quot;&#x27;]&quot;);
                    cellData = columnCells.find(&#x27;.cell-data&#x27;);

                    if (cellData.length &gt; 0) {
                        cellDataWidth = Math.max.apply( null, cellData.map( function () {
                            return $(this).outerWidth( true );
                        }).get() );
                    }

                    cellWidth = Math.max.apply( null, columnCells.map( function () {
                        return $(this).outerWidth( true );
                    }).get() );

                    headerWidth = currColHeader.outerWidth( true );


                    cellWidth = Math.max(cellDataWidth, cellWidth);

                    // The last column needs to take into account the scrollbar
                    if (index !== (scope.tableColumns.length - 1)) {
                        newWidth = Math.max(cellWidth, headerWidth);

                        currColHeader.css(&#x27;width&#x27;, newWidth);
                        // for text-wrap: ellipsis
                        cellData.css(&#x27;max-width&#x27;, newWidth);
                        columnCells.css(&#x27;width&#x27;, newWidth);
                    }
                });

                // For the scrollbar in the last column
                if (cellWidth &gt; (headerWidth - scrollbarWidth)) {
                    headerWidth = cellWidth + scrollbarWidth;
                } else {
                    cellWidth = headerWidth - scrollbarWidth;
                }

                currColHeader.css(&#x27;width&#x27;, headerWidth);
                columnCells.css(&#x27;width&#x27;, cellWidth);
                cellData.css(&#x27;max-width&#x27;, cellWidth);
            }

            /**
             * Angular filtering rewrites everything in the table on the DOM,
             * this is incredibly slow. Our sort simply adds a class that hides
             * any filtered objects and is much faster.
             *
             * @method filterScrollableTable
             * @return none
             */
            function filterScrollableTable() {

                scope.visibleRowCount = 0;
                scope.filteredRowCount = 0;
                _.each (trows, function(row) {
                    var rowElem = $(row);
                    _.each(scope.filterObject, function(filterVal, filterCol) {
                        var rowValue = rowElem.find(&quot;.app-td[data-col-header=&#x27;&quot; + filterCol + &quot;&#x27;] &gt; .cell-data&quot;).html();
                        if (rowValue.indexOf(filterVal) === -1) {
                            rowElem.addClass(&#x27;filtered&#x27;);
                            ++scope.filteredRowCount;
                        } else {
                            ++scope.visibleRowCount;
                            if ((scope.visibleRowCount % 2) === 0) {
                                rowElem.addClass(&#x27;even-row&#x27;);
                            } else {
                                rowElem.removeClass(&#x27;even-row&#x27;);
                            }
                            rowElem.removeClass(&#x27;filtered&#x27;);
                        }
                    });
                });
            }

            /**
             * Sets row color for every other row on a scrollable table, $index
             * doesn&#x27;t work since we are using css/classes to hide rows instead
             * of removing them from the DOM
             *
             * @method setScrollableRowColors
             * @return none
             */
            function setScrollableRowColors() {
                var visibleRowCount = 0;
                _.each (trows, function(row) {
                    var rowElem = $(row);
                    if (!rowElem.hasClass(&#x27;filtered&#x27;)) {
                        ++visibleRowCount;
                        if ((visibleRowCount % 2) === 0) {
                            rowElem.addClass(&#x27;even-row&#x27;);
                        } else {
                            rowElem.removeClass(&#x27;even-row&#x27;);
                        }
                    }
                });
                safeApply(scope);
            }

            /**
             * Calculates the number of visible rows on a scrollable table using
             * the properties of the table and rows
             *
             * @method calculateVisibleRows
             * @return none
             */
            function calculateVisibleRows() {
                var containerHeight = tbody.innerHeight(),
                    containerScroll = tbody.scrollTop();
                scope.visibleRowsStartIndex = parseInt(containerScroll / rowHeight + visibleStartRowMargin) + 1;
                scope.visibleRowsEndIndex = parseInt((containerScroll + containerHeight) / rowHeight + visibleEndRowMargin);
                safeApply(scope);
            }

             /**
             * used to determine the ng-class of our headers, to show what is
             * being used to sort the table and in what direction
             *
             * @method scope.isSortingBy
             * @param {String} col
             *  The name of the column being checked
             * @return {Integer} 0 for not sorted, 1 for Asc sort, -1 for Desc
             */
            scope.isSortingBy = function(col) {
                var sanitizedCol = sanitizePredicate(col),
                    sanitizedReverseCol = sanitizePredicate(col, true),
                    ret = 0;

                _.each(scope.predicate, function(value) {
                    if (value === sanitizedCol) {
                        ret = 1;

                        // return false will break from lodash foreach
                        return false;
                    } else if (value === sanitizedReverseCol) {
                        ret = -1;

                        return false;
                    }
                });

                return ret;
            };

            /**
             * Generates a sorting predicate for angular to base its sort on
             *
             * @method scope.sortTableBy
             * @param {String} predicate
             *  The name of the new column to sort by
             * @return none
             */
            scope.sortTableBy = function(predicate) {
                var currIndex        = scope.predicate.indexOf(sanitizePredicate(predicate)),
                    currReverseIndex = scope.predicate.indexOf(sanitizePredicate(predicate, true)),
                    reverse = true;

                if (currIndex === -1 &amp;&amp; currReverseIndex !== -1) {
                    currIndex = currReverseIndex;
                    reverse = false;
                }

                if (currIndex !== -1 &amp;&amp; hotkeysFactory.keybindings.shiftKey) {
                    if (scope.predicate.length &gt; 1) {
                        scope.predicate.splice(currIndex, 1);
                    } else {
                        scope.predicate[currIndex] = sanitizePredicate(predicate, reverse);
                    }
                } else if (currIndex !== -1 &amp;&amp; !hotkeysFactory.keybindings.shiftKey) {
                    scope.predicate[currIndex] = sanitizePredicate(predicate, reverse);
                } else if (currIndex === -1 &amp;&amp; hotkeysFactory.keybindings.shiftKey) {
                    scope.predicate.push(sanitizePredicate(predicate));
                } else {
                    scope.predicate = [sanitizePredicate(predicate)];
                }

                if (scope.pagingType &amp;&amp; (scope.pagingType === &#x27;scrollable&#x27; || scope.pagingType === &#x27;scrollable-paging&#x27;)) {
                    $timeout(function() {
                        trows = tbody.find(&#x27;.app-tr&#x27;);
                        setScrollableRowColors();
                    }, 0);
                }
            };


            /**
             * Determines if enough filter values are set to filter our table
             *
             * @method scope.handleFilterChange
             * @param {String} [item]
             *  The name of a column selected by the dropdown, possibly null
             * @return none
             */
            scope.handleFilterChange = function(item) {
                var column,
                    input = filterInputElem.val();

                if (item &amp;&amp; (typeof item === &#x27;string&#x27;)) {
                    column = item;
                } else {
                    column = filterColumnElem.val();
                }

                scope.filterObject = {};
                if (column &amp;&amp; input) {
                    scope.filterObject[column] = input;

                    if (!scope.pagingType || scope.pagingType === &#x27;basic&#x27;) {
                        scope.filteredRows = filterFilter(scope.tableData, scope.filterObject);
                        scope.calculatePageCount();
                    } else if (scope.pagingType === &#x27;scrollable&#x27; || scope.pagingType === &#x27;scrollable-paging&#x27;) {
                        $timeout(function() {
                            filterScrollableTable();
                            setScrollableRowColors();
                        }, 0);
                    }
                }
            };

            /**
             * Calculates the number of pages depending on the page size
             *
             * @method scope.calculatePageCount
             * @param {Integer} [newSize]
             *  A new page size passed in from the dropdown, possibly null
             * @return none
             */
            scope.calculatePageCount = function (newSize) {
                var rowCount,
                    pageSize = scope.pager.pageSize.value,
                    remainder;

                if(!scope.pagingType || scope.pagingType === &#x27;basic&#x27;) {
                    if (newSize) {
                        scope.pager.pageSize.value = newSize;
                        pageSize = newSize;
                    }
                    rowCount = scope.filteredRows.length;
                    remainder = (rowCount % pageSize) ? 1 : 0;
                } else if (scope.pagingType === &#x27;scrollable-paging&#x27;) {
                    scope.pager.pageSize.value = scope.visibleRowsEndIndex - scope.visibleRowsStartIndex + 1;
                    pageSize = scope.pager.pageSize.value;

                    rowCount = scope.visibleRowCount;
                    remainder = (rowCount % pageSize) ? 1 : 0;
                }

                scope.pager.pageCount = (rowCount / pageSize) + remainder;
            };

            /**
             * Changes the table to the newly selected page
             *
             * @method scope.selectPage
             * @param {Integer} pageNumber
             *  The index of the page we need to switch to
             * @return none
             */
            scope.selectPage = function(pageNumber) {
                var pageSize = scope.pager.pageSize.value;
                scope.pager.currentPage = pageNumber;
                scope.pager.currentIndex = pageNumber * pageSize;

                if (scope.pagingType &amp;&amp; scope.pagingType === &#x27;scrollable-paging&#x27;) {
                    tbody.animate({
                        scrollTop: pageNumber * pageSize * rowHeight
                    }, 1000);
                }
            };

            /**
             * onSelect override function for the table dropdowns.
             *
             * @method scope.selectionHandler
             * @param {String} item
             *  The selected item.
             * @param {String} column
             *  The name of the column containing the dropdown that was used.
             * @param {Integer} rowIndex
             *  The index of the row that was selected, does not currently work.
             * @return none
             */
            scope.selectionHandler = function(item, column, rowIndex) {
                console.log(&#x27;selected made on row &#x27; + rowIndex + &#x27; in col &#x27; + column + &#x27;, value: &#x27; + item);

                // In the case we pick a selection larger than the column width
                $timeout(function () {
                    setColumnWidths();
                }, 0);
            };

            scope.tableData = scope.tableConfig.tableData;
            if(scope.tableConfig.columns) {
                scope.tableColumns = scope.tableConfig.columns;
            } else {
                scope.tableColumns = [];
                _.each(scope.tableData[0], function(value, key) {
                    if(!scope.tableConfig.ignoredData || scope.tableConfig.ignoredData.indexOf(key) === -1) {
                        scope.tableColumns.push(key);
                    }
                });
            }

            scope.filter = {
                column: {
                    value: &#x27;&#x27;
                },
                input: {
                    value: &#x27;&#x27;
                }
            };

            scope.pager = {
                minPageSize: 5,
                maxPageSize: 15,
                pageSize: {
                    value: 8
                },
                currentIndex: 0,
                currentPage: 0
            };

            if (scope.minPageSize) {
                scope.pager.minPageSize = scope.minPageSize;
            } else {
                scope.pager.minPageSize = 5;
            }
            if (scope.maxPageSize) {
                scope.pager.maxPageSize = scope.maxPageSize;
            } else {
                scope.pager.maxPageSize = 15;
            }

            if (!scope.pagingType || scope.pagingType === &#x27;basic&#x27;) {
                scope.filteredRows = filterFilter(scope.tableData, scope.filterObject);
            }

            scope.predicate = [sanitizePredicate(scope.tableColumns[0])];
            scope.reverse = true;

            $timeout(function() {
                tbody = elem.find(&#x27;.app-tbody&#x27;);
                thead = elem.find(&#x27;.app-thead&#x27;);
                trows = tbody.find(&#x27;.app-tr&#x27;);
                theadCols = thead.find(&#x27;.app-th&#x27;);
                _.each(scope.tableColumns, function(value) {
                    tcols[value] = tbody.find(&quot;.app-td[data-col-header=&#x27;&quot; + value + &quot;&#x27;]&quot;);
                });

                rowHeight = parseInt(trows.outerHeight());
                scrollbarWidth = getScrollbarWidth();
                calculateVisibleRows();
                scope.rowCount = trows.length;
                scope.visibleRowCount = scope.rowCount;
                scope.calculatePageCount(scope.pager.pageSize.value);

                scope.pager.availPageSizes = [];
                for(var i = scope.pager.minPageSize; i &lt;= scope.pager.maxPageSize; ++i) {
                    scope.pager.availPageSizes.push(i);
                }
                initHotkeys();
                if (scope.pagingType &amp;&amp; (scope.pagingType === &#x27;scrollable&#x27; || scope.pagingType === &#x27;scrollable-paging&#x27;)) {
                    setColumnWidths();

                    setScrollableRowColors();

                    tbody.on(&#x27;scroll&#x27;, calculateVisibleRows);
                    $(window).on(&#x27;resize&#x27;, function() {
                        scope.calculatePageCount();
                        calculateVisibleRows();
                    });
                }

                filterInputElem = $(element).find(&#x27;.filter-input &gt; input&#x27;);
                filterColumnElem = $(element).find(&#x27;.filter-column &gt; input&#x27;);
                filterInputElem.on(&#x27;input&#x27;, scope.handleFilterChange);

                elem.find(&#x27;.app-table&#x27;).removeClass(&#x27;loading&#x27;);
            }, 0);
        }
    };
}]);

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
